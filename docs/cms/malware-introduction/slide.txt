# 恶意代码

---

## 基本概念

* 相关术语
  * <b style="color:red">恶意代码：Malicious Code</b>
  * <b style="color:red">恶意软件：Malware</b>
  * <b style="color:red">垃圾（信息）：Spam</b>
* 恶意代码的核心特征
  * 执行结果非用户期望且包含恶意目的
  * 恶意软件是由恶意代码编制而成
* 垃圾信息借助恶意代码和恶意软件加速传播

---

## 发展阶段

--

### 原始病毒

1. 产生年限为1986-1989年之间。
2. 由于当时的计算机软件少，大多是单机运行，病毒没有大量流行，种类有限，清除相对容易。
3. 攻击目标较单一，主要通过截获系统中端向量的方式监视系统的运行状态，并在一定的条件下传染。
4. 病毒不具备自我保护的措施。

--

### 混合病毒

1. 产生年限在1989-1991年之间，是计算机病毒由简单发展到复杂的阶段。
2. 计算机局域网的应用和普及给计算机病毒带来了第一次流行高峰。
3. 攻击目标趋于混合，采取更隐蔽的方式驻留内存和传染目标，并且没有明显的特征，采取了自我保护的措施，出现很多的病毒的变种。

--

### 多态病毒

1. 在每次传染目标时，宿主程序中的病毒程序大部分是可变的，防病毒软件查杀时非常困难。
2. 这一阶段开始，病毒技术开始向多维化方向发展

--

### 网络病毒

1. 从20世纪90年代中后期开始，依赖互联网传播的邮件病毒和宏病毒等大量涌现。
2. 病毒传播快，隐蔽性强，破坏性大。

--

### 攻击病毒

1. 典型代表是2003年的冲击波病毒和2004年的震荡波病毒。
2. 这些病毒利用操作系统的漏洞进行进攻性的扩散，不需要任何的媒介和操作，危害性更大。

--

### 移动端病毒

1. 随着移动通信网络的发展及移动终端的不断增强，计算机病毒走进了移动世界，手机用户覆盖面广，数量多，病毒危害和影响也就更大。

--

### 高级持续性威胁（APT）

1. 不是一种病毒。
2. 是一种攻击手段。
3. Advanced / Persistent / Threat
4. 2010年 Google极光攻击，持续数月
5. 2011年 夜龙攻击被McAfee曝光，始于2007年
6. 2010年 伊朗核电站遭到Stuxnet蠕虫（震网）攻击
7. 2011年 震网二代 Duqu肆虐欧洲

--

### 发展趋势

* 网络化
* 专业化
* 多样化
* 自动化

---

## 恶意代码的特征

* 自我保护性强
* 诱惑欺骗性强
* 向多元化发展
* 传播方式多样
* 传播速度更快
* 攻击技术混合
* 破坏日益严重

---

## 恶意代码分类

--

### 动机分类

![分类](images/malicious-code.png)

--

### 植入方式分类

* 源码型（恶意代码插入到源程序中，编译成为合法程序的一部分）
* 嵌入型（将自身嵌入到现有程序中，使恶意代码与目标程序代码成为一体，清除会破坏合法程序）
* 外壳型（一般链接到宿主程序的首尾，宿主程序执行首先激活恶意代码）
* 操作系统型（加入或者取代部分操作系统进行工作，寄生在计算机磁盘的操作系统区）

--

### 寄生方式分类

* 引导型（恶意代码程序取代正常的引导记录，占据了引导区的物理位置即可获得控制权）
* 文件型（通过操作系统的文件系统实施感染，以感染可执行文件为主）
* 混合型（综合了引导型恶意代码和文件型恶意代码的特点同时感染文件和引导扇区，同时使用加密和变形算法）

---

## 常见类型

--

### 宏病毒（Macro Virus）

* 宏是微软为office软件设计的功能，提供任务的自动化。如果宏中包含了有破坏能力的命令和自我复制的功能，这个宏就成了宏病毒。
* 宏病毒常见的是针对word，excel，powerpoint等office软件，通过宏录制器和Visual Basic编辑器来创建宏。
* 宏被存储在通用模板中，一执行程序，受感染的模板就会传播到所编辑的文档中去，并以此方式不断地感染。

--

### 恶意脚本

* 网页恶意脚本
  * XSS、CSRF
* 操作系统恶意脚本
  * JS、bat、cmd脚本

--

### 蠕虫病毒（Worm）

* 蠕虫强调自身副本的完整性和独立性，主要通过计算机漏洞来进行传染
* 蠕虫的特点和发展趋势
  * 利用系统和程序的漏洞主动攻击
  * 传播方式多样
  * 影响范围大，感染主机数量多
  * 制作技术新
  * 与黑客技术相结合

--

### 木马（Trojan Horse）

* 木马一般有客户端和服务器端两个程序，植入的木马会发送系统信息给服务器端
  * 客户端：植入端
  * 服务端：控制端
* 木马的基本特征
  * 隐蔽性
  * 自动运行
  * 欺骗性
  * 自动恢复
  * 控制性强（远程控制，键盘记录等）

--

### 命名

![命名](images/malwarenaming.png)

* <span style="font-size:0.7em">Type: 恶意代码类型/分类</span>&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-size:0.7em">Platform：感染/运行平台环境</span>
* <span style="font-size:0.7em">Family: 恶意代码家族名</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="font-size:0.7em">Variant: 变种名</span>
* <span style="font-size:0.7em">Information：扩展说明</span>

<p style="text-align:left;font-size:0.5em">注：https://docs.microsoft.com/zh-cn/windows/security/threat-protection/intelligence/malware-naming</p>

---

## 恶意代码基本结构（1/2）

* 引导模块
  * 使恶意代码获得执行并使后面的两个模块处于激活状态
* 传染模块
  * 传染条件满足时把恶意代码传染到被攻击的对象上
* 破坏模块
  * 在恶意代码破坏，发作条件满足时，实施对系统的干扰和破坏活动

--

### 恶意代码基本结构（2/2）

* 寄生对象
  * 磁盘引导扇区
  * 特定可执行文件、系统文件
  * PDF、Word类文档
* 驻留内存
  * 占据磁盘引导区中系统引导程序的位置，系统启动时自动装入内存获得控制权
  * 修改原文件使对该文件的操作转入病毒的引导模块
* 窃取系统控制权
* 恢复系统功能

---

## 恶意代码传染机制

* 传染是恶意代码由一个载体传播到另一个载体，由一个系统进入另一个系统
* 被动传染是基于系统的复制和系统I/O传输工作进行的
  * 网络传输
  * 外部存储设备：U盘、NFS等
* 主动传染时系统常驻内存并监视系统运行，伺机采取手段传染

---

## 恶意代码触发机制

* 日期触发
* 键盘触发
* 启动触发
* 邮件触发
* 漏洞触发
* 磁盘访问触发

---

## 关键技术

![关键技术](images/malwaretech.png)

--

### 自我复制

* 利用代码实现自我复制
* 社会工程学手段

![社会工程学](images/social-engineering.png)

--

### 隐藏

* 变形，混淆，加密
* Rootkit技术
  * 文件隐藏
  * 注册表隐藏
  * 网络连接隐藏
* 进程隐藏
* 不驻留文件系统，注册表
  * 驻留BIOS，MBR，内存
* 寄生于代码，进程，内存中

--

### 传播

* 社会工程学手段
  * 电子邮件，即时通信，网站，SNS
* 基于漏洞的传播
  * 漏洞利用代码中包含恶意代码
* 文件捆绑
  * 在下载的破解软件中捆绑恶意代码
  * 手机第三方定制ROM中预置恶意代码
  * 电子邮件附件，自解压缩文件
  * 漏洞利用代码，宏代码

--

### 控制

* 木马
  * 主动监听，等待连接
  * 反向连接，绕过防火墙
  * 主动接受指令
  * 远程控制(网页，邮件，DNS解析，IRC)
  * 屏幕监控
  * 键盘记录

--

### 自我保护

* 隐藏
  * 自身隐藏来躲避查杀
* 对抗检测
  * 变形，混淆，加密
* 对抗清除
  * 双守护进程保护
  * 变种更新，对抗查杀

---

## 恶意代码检测

--

### 特征代码法

* 计算机病毒中一般都带有明显的特征代码，该方法是最为普遍的病毒检测方法。
* 优点：
  * 检测准确快速，误报率低
* 缺点：
  * 从未见过的病毒无法检测，必须不断更新病毒库
  * 随着病毒种类的增加，检索时间变长
  * 不能检测多态和隐蔽性病毒

--

### 校验和法

* 根据正常文件的信息（名称，大小，内容），计算其校验和，通过检查校验和来判断是否发现病毒
* 优点：
  * 方法简单，可以发现已知和未知的病毒
* 缺点：
  * 对文件内容的变化过于敏感，误报率高
  * 影响文件运行速度，不能对付隐蔽性病毒

--

### 行为监测法

* 利用病毒的特有行为特征来监测病毒的方法称为行为监测法
* 优点：
  * 可发现未知病毒，准确的预报未知的多种病毒
* 缺点：
  * 可能误报警
  * 不能识别病毒名称
  * 实现有一定的难度

---

## 恶意代码分析方法

* 静态分析
  * 利用反汇编工具将恶意代码转换为源代码或汇编代码进行分析
  * 发现恶意代码的模块组成，编程技巧，感染方法，标示特征代码
* 动态分析
  * 在恶意代码执行的情况下，利用程序调试工具进行跟踪和观察，确定工作过程

---

## Q & A