# 恶意代码常见行为与检测

---

## 注册表

--

### 简介

<p style="text-align:left">注册表在windows系统的配置和控制方面扮演了一个非常关键的角色，它既是系统全局设置的存储仓库，也是每个用户的设置信息的存储仓库。</p>

--

### 打开方式

<p style="text-align:left">快捷键 Win + R 打开运行窗口，输入`regedit`并在弹出`UAC`对话框中选择允许。</p>

![注册表](/courses-wiki/img/regedit.png)

--

### 五个根节点

* HKEY_CLASSES_ROOT，存储各类不同文件扩展名对应的默认打开程序。
* HKEY_CURRENT_USER，当前用户的配置数据信息。
* HKEY_LOCAL_MACHINE，硬件、计算机所有用户的配置数据信息。
* HKEY_USERS，计算机默认用户的配置文件和已知用户的配置文件的子项。
* HKEY_CURRENT_CONFIG，当前硬件配置信息。

---

## 恶意软件常见自启动方式

--

### 注册表-当前用户启动

```
HKEY_CURRENT_USER\
  Software\
    Microsoft\
      Windows\
        CurrentVersion\
          Run
```

![注册表自启动](/courses-wiki/img/regedit_hcu_run.png)<!-- .element height="60%" width="60%" -->

--

### 注册表-所有用户启动

```
HKEY_LOCAL_MACHINE\
  SOFTWARE\
    Microsoft\
      Windows\
        CurrentVersion\
          Run
```

![注册表自启动](/courses-wiki/img/regedit_hlm_run.png)<!-- .element height="60%" width="60%" -->

--

### 注册表-ExplorerHook

```
HKEY_LOCAL_MACHINE\
  SOFTWARE\
    Microsoft\
      Windows\
        CurrentVersion\
          Explorer\
            ShellExecuteHooks
```

![注册表自启动](/courses-wiki/img/regedit_hook_run.png)<!-- .element height="60%" width="60%" -->

--

### 注册表-AppInit_DLLs

<p style="font-size:0.6em;text-align:left;">source: https://support.microsoft.com/en-us/help/197571/working-with-the-appinit-dlls-registry-value</p>

```
HKEY_LOCAL_MACHINE\
  SOFTWARE\
    Microsoft\
      Windows NT\
        CurrentVersion\
          Windows\
            AppInit_DLLs
```

![注册表自启动](/courses-wiki/img/regedit_dll_run.png)<!-- .element height="60%" width="60%" -->

--

### 注册表-IFEO

```
HKEY_LOCAL_MACHINE\
  SOFTWARE\
    Microsoft\
      Windows NT\
        CurrentVersion\
          Image File Execution Options
```

![注册表自启动](/courses-wiki/img/regedit_ifeo_run.png)<!-- .element height="60%" width="60%" -->

--

### 注册表-BHO

```
HKEY_LOCAL_MACHINE\
  SOFTWARE\
    Microsoft\
      Windows\
        CurrentVersion\
          Explorer\
            Browser Helper Objects
```

![注册表自启动](/courses-wiki/img/regedit_bho_run.png)<!-- .element height="60%" width="60%" -->

--

### 系统路径

* Windows / System32 / Temp
* 替换或伪装成系统文件来实现自动加载。

--

### 其他

* 设置为系统文件。
* 设置为隐藏文件。
* 利用系统漏洞。

---

## 分析工具和检测

--

### PC Hunter

* PC Hunter工具最大的特点就是采用了很多内核级的方法和手段，使得检测和清除效果得到提升。
* 显示所有的隐藏进程，隐藏文件，隐藏端口，隐藏服务，并且可以轻松杀掉相关的进程，禁用服务。
* 可以直接的删除已经加载的驱动文件，受保护的注册表和流氓软件中无法正常删除的文件。

--

### 主界面

![PC Hunter](/courses-wiki/img/pchunter.png)

--

### 窗口标题随机

![随机标题](/courses-wiki/img/random_title.png)

--

### 禁止创建新进程

![禁止进程](/courses-wiki/img/forbidden_new_process.png)

--

### 强制结束进程

![强制结束进程](/courses-wiki/img/terminate_process.png)

--

### 卸载模块

![卸载模块](/courses-wiki/img/detach_dll.png)

--

### 分析卸载驱动

![分析卸载驱动](/courses-wiki/img/analyze_drivers.png)

--

### 查看隐藏端口

![查看隐藏端口](/courses-wiki/img/scan_ports.png)

--

### 管理注册表

![管理注册表](/courses-wiki/img/manage_regedit.png)

--

### 管理文件

![管理文件](/courses-wiki/img/manage_files.png)

---

## 安全卫士时代手动分析工具

* IceSword
* XueTr / PC Hunter
  * XueTr支持32位的2000、XP、2003、Vista、2008、Win7系统
  * PC Hunter支持32/64位的Win7-Win10
  * http://www.xuetr.com/ 
* PowerTool
  * 持续更新维护中，支持Win 8.1和64位系统
  * 作者微博：http://weibo.com/powertool
* Win64AST 
  * 专用于64位Windows的Anti-RootKit类工具
  * http://m5home.blog.163.com/

---

## Q & A